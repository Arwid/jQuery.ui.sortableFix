/*!
 * jQuery.ui.sortableFix - This plugin overrides some methods in ui.sortable to fix 
 * several issues.
 *
 * Copyright 2011 Arwid Bancewicz
 * Licensed under the MIT lice
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * @date 23 Feb 2011
 * @author Arwid Bancewicz http://arwid.ca
 * @version 0.1
 */
(function(a){a.ui.contains=function(){return false};a.widget("ui.sortable",a.extend({},a.ui.sortable.prototype,{_intersectsWithPointerOrig:a.ui.sortable.prototype._intersectsWithPointer,_intersectsWithPointer:function(c){var b=this.options.connectWith?a(c.item[0]).closest(this.options.connectWith):this.element;if(this.positionAbs.top<b.offset().top||this.positionAbs.top>b.offset().top+b.height()){return false}return this._intersectsWithPointerOrig(c)},_rearrange:function(c,g,k,e){if(k){var d=a(k[0]);var m=d.offset().top;var j=m+d.outerHeight(true);var f=(j-m)/2+m;if(c.clientY>f){this.direction="down";var l=a(k[0]).find(this.options.items+":last");if(l.size()){l.after(this.placeholder[0])}else{k[0].insertBefore(this.placeholder[0],k[0].childNodes[0])}}else{this.direction="up";var h=a(k[0]).find(this.options.items+":first");if(h.size()){h.before(this.placeholder[0])}else{k[0].insertBefore(this.placeholder[0],k[0].childNodes[0])}}}else{(this.direction=="down"?this._insertAbove(this.placeholder[0],g.item[0]):this._insertBelow(this.placeholder[0],g.item[0]))}this.counter=this.counter?++this.counter:1;var n=this,b=this.counter;window.setTimeout(function(){if(b==n.counter){n.refreshPositions(!e)}},0)},_insertBelow:function(e,b){console.log("_insertBelow");var c=this._below(a(b),true);if(c.size()){a(e).insertBefore(c)}else{var d=this._below(a(b),true);if(d.size()){a(e).insertBefore(this._below(a(b)))}else{a(e).insertAfter(a(b))}}},_insertAbove:function(e,c){var d=this._above(a(c),true);if(d.size()){a(e).insertBefore(c)}else{var b=this._above(a(c));if(b.size()){a(e).insertAfter(b)}else{a(e).insertBefore(c)}}},_above:function(e,c){var d=e.prev(this.options.items);if(c||d.size()==0){return e.parent().closest(this.options.items)}else{var b=d.find(this.options.items+":last");if(b.size()){return b}else{return d}}},_below:function(b,c){var d=b.find(this.options.items+":first");if(c){return d}if(d.size()){return d}else{d=b;while(d.next(this.options.items).size()==0&&d.parent().size()!=0){d=d.parent().closest(this.options.items)}return d.next(this.options.items)}}}))})(jQuery);(function(){var k;if(typeof exports!=="undefined"){k=exports}else{k=this.Backbone={}}k.VERSION="0.3.3";var m=this._;if(!m&&(typeof require!=="undefined")){m=require("underscore")._}var e=this.jQuery||this.Zepto;k.emulateHTTP=false;k.emulateJSON=false;k.Events={bind:function(r,t){var q=this._callbacks||(this._callbacks={});var s=this._callbacks[r]||(this._callbacks[r]=[]);s.push(t);return this},unbind:function(t,v){var s;if(!t){this._callbacks={}}else{if(s=this._callbacks){if(!v){s[t]=[]}else{var u=s[t];if(!u){return this}for(var r=0,q=u.length;r<q;r++){if(v===u[r]){u.splice(r,1);break}}}}}return this},trigger:function(t){var u,s,r,q;if(!(s=this._callbacks)){return this}if(u=s[t]){for(r=0,q=u.length;r<q;r++){u[r].apply(this,Array.prototype.slice.call(arguments,1))}}if(u=s.all){for(r=0,q=u.length;r<q;r++){u[r].apply(this,arguments)}}return this}};k.Model=function(q,r){q||(q={});if(this.defaults){q=m.extend({},this.defaults,q)}this.attributes={};this._escapedAttributes={};this.cid=m.uniqueId("c");this.set(q,{silent:true});this._previousAttributes=m.clone(this.attributes);if(r&&r.collection){this.collection=r.collection}this.initialize(q,r)};m.extend(k.Model.prototype,k.Events,{_previousAttributes:null,_changed:false,initialize:function(){},toJSON:function(){return m.clone(this.attributes)},get:function(q){return this.attributes[q]},escape:function(q){var r;if(r=this._escapedAttributes[q]){return r}var s=this.attributes[q];return this._escapedAttributes[q]=o(s==null?"":s)},set:function(t,s){s||(s={});if(!t){return this}if(t.attributes){t=t.attributes}var r=this.attributes,u=this._escapedAttributes;if(!s.silent&&this.validate&&!this._performValidation(t,s)){return false}if("id" in t){this.id=t.id}for(var q in t){var v=t[q];if(!m.isEqual(r[q],v)){r[q]=v;delete u[q];if(!s.silent){this._changed=true;this.trigger("change:"+q,this,v,s)}}}if(!s.silent&&this._changed){this.change(s)}return this},unset:function(q,r){r||(r={});var t=this.attributes[q];var s={};s[q]=void 0;if(!r.silent&&this.validate&&!this._performValidation(s,r)){return false}delete this.attributes[q];delete this._escapedAttributes[q];if(!r.silent){this._changed=true;this.trigger("change:"+q,this,void 0,r);this.change(r)}return this},clear:function(r){r||(r={});var q=this.attributes;var s={};for(attr in q){s[attr]=void 0}if(!r.silent&&this.validate&&!this._performValidation(s,r)){return false}this.attributes={};this._escapedAttributes={};if(!r.silent){this._changed=true;for(attr in q){this.trigger("change:"+attr,this,void 0,r)}this.change(r)}return this},fetch:function(s){s||(s={});var r=this;var t=function(u){if(!r.set(r.parse(u),s)){return false}if(s.success){s.success(r,u)}};var q=d(s.error,r,s);(this.sync||k.sync)("read",this,t,q);return this},save:function(t,s){s||(s={});if(t&&!this.set(t,s)){return false}var r=this;var u=function(w){if(!r.set(r.parse(w),s)){return false}if(s.success){s.success(r,w)}};var q=d(s.error,r,s);var v=this.isNew()?"create":"update";(this.sync||k.sync)(v,this,u,q);return this},destroy:function(s){s||(s={});var r=this;var t=function(u){if(r.collection){r.collection.remove(r)}if(s.success){s.success(r,u)}};var q=d(s.error,r,s);(this.sync||k.sync)("delete",this,t,q);return this},url:function(){var q=h(this.collection);if(this.isNew()){return q}return q+(q.charAt(q.length-1)=="/"?"":"/")+this.id},parse:function(q){return q},clone:function(){return new this.constructor(this)},isNew:function(){return !this.id},change:function(q){this.trigger("change",this,q);this._previousAttributes=m.clone(this.attributes);this._changed=false},hasChanged:function(q){if(q){return this._previousAttributes[q]!=this.attributes[q]}return this._changed},changedAttributes:function(s){s||(s=this.attributes);var r=this._previousAttributes;var t=false;for(var q in s){if(!m.isEqual(r[q],s[q])){t=t||{};t[q]=s[q]}}return t},previous:function(q){if(!q||!this._previousAttributes){return null}return this._previousAttributes[q]},previousAttributes:function(){return m.clone(this._previousAttributes)},_performValidation:function(s,r){var q=this.validate(s);if(q){if(r.error){r.error(this,q)}else{this.trigger("error",this,q,r)}return false}return true}});k.Collection=function(r,q){q||(q={});if(q.comparator){this.comparator=q.comparator;delete q.comparator}this._boundOnModelEvent=m.bind(this._onModelEvent,this);this._reset();if(r){this.refresh(r,{silent:true})}this.initialize(r,q)};m.extend(k.Collection.prototype,k.Events,{model:k.Model,initialize:function(){},toJSON:function(){return this.map(function(q){return q.toJSON()})},add:function(t,r){if(m.isArray(t)){for(var s=0,q=t.length;s<q;s++){this._add(t[s],r)}}else{this._add(t,r)}return this},remove:function(t,r){if(m.isArray(t)){for(var s=0,q=t.length;s<q;s++){this._remove(t[s],r)}}else{this._remove(t,r)}return this},get:function(q){if(q==null){return null}return this._byId[q.id!=null?q.id:q]},getByCid:function(q){return q&&this._byCid[q.cid||q]},at:function(q){return this.models[q]},sort:function(q){q||(q={});if(!this.comparator){throw new Error("Cannot sort a set without a comparator")}this.models=this.sortBy(this.comparator);if(!q.silent){this.trigger("refresh",this,q)}return this},pluck:function(q){return m.map(this.models,function(r){return r.get(q)})},refresh:function(r,q){r||(r=[]);q||(q={});this._reset();this.add(r,{silent:true});if(!q.silent){this.trigger("refresh",this,q)}return this},fetch:function(r){r||(r={});var t=this;var s=function(u){t.refresh(t.parse(u));if(r.success){r.success(t,u)}};var q=d(r.error,t,r);(this.sync||k.sync)("read",this,s,q);return this},create:function(r,q){var s=this;q||(q={});if(!(r instanceof k.Model)){r=new this.model(r,{collection:s})}else{r.collection=s}var t=function(u,v){s.add(u);if(q.success){q.success(u,v)}};return r.save(null,{success:t,error:q.error})},parse:function(q){return q},chain:function(){return m(this.models).chain()},_reset:function(q){this.length=0;this.models=[];this._byId={};this._byCid={}},_add:function(s,r){r||(r={});if(!(s instanceof k.Model)){s=new this.model(s,{collection:this})}var t=this.getByCid(s);if(t){throw new Error(["Can't add the same model to a set twice",t.id])}this._byId[s.id]=s;this._byCid[s.cid]=s;s.collection=this;var q=this.comparator?this.sortedIndex(s,this.comparator):this.length;this.models.splice(q,0,s);s.bind("all",this._boundOnModelEvent);this.length++;if(!r.silent){s.trigger("add",s,this,r)}return s},_remove:function(r,q){q||(q={});r=this.getByCid(r)||this.get(r);if(!r){return null}delete this._byId[r.id];delete this._byCid[r.cid];delete r.collection;this.models.splice(this.indexOf(r),1);this.length--;if(!q.silent){r.trigger("remove",r,this,q)}r.unbind("all",this._boundOnModelEvent);return r},_onModelEvent:function(r,q){if(r==="change:id"){delete this._byId[q.previous("id")];this._byId[q.id]=q}this.trigger.apply(this,arguments)}});var c=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty"];m.each(c,function(q){k.Collection.prototype[q]=function(){return m[q].apply(m,[this.models].concat(m.toArray(arguments)))}});k.Controller=function(q){q||(q={});if(q.routes){this.routes=q.routes}this._bindRoutes();this.initialize(q)};var p=/:([\w\d]+)/g;var f=/\*([\w\d]+)/g;m.extend(k.Controller.prototype,k.Events,{initialize:function(){},route:function(q,r,s){k.history||(k.history=new k.History);if(!m.isRegExp(q)){q=this._routeToRegExp(q)}k.history.route(q,m.bind(function(u){var t=this._extractParameters(q,u);s.apply(this,t);this.trigger.apply(this,["route:"+r].concat(t))},this))},saveLocation:function(q){k.history.saveLocation(q)},_bindRoutes:function(){if(!this.routes){return}for(var q in this.routes){var r=this.routes[q];this.route(q,r,this[r])}},_routeToRegExp:function(q){q=q.replace(p,"([^/]*)").replace(f,"(.*?)");return new RegExp("^"+q+"$")},_extractParameters:function(q,r){return q.exec(r).slice(1)}});k.History=function(){this.handlers=[];this.fragment=this.getFragment();m.bindAll(this,"checkUrl")};var l=/^#*/;m.extend(k.History.prototype,{interval:50,getFragment:function(q){return(q||window.location).hash.replace(l,"")},start:function(){var q=document.documentMode;var r=(e.browser.msie&&(!q||q<=7));if(r){this.iframe=e('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow}if("onhashchange" in window&&!r){e(window).bind("hashchange",this.checkUrl)}else{setInterval(this.checkUrl,this.interval)}return this.loadUrl()},route:function(q,r){this.handlers.push({route:q,callback:r})},checkUrl:function(){var q=this.getFragment();if(q==this.fragment&&this.iframe){q=this.getFragment(this.iframe.location)}if(q==this.fragment||q==decodeURIComponent(this.fragment)){return false}if(this.iframe){window.location.hash=this.iframe.location.hash=q}this.loadUrl()},loadUrl:function(){var r=this.fragment=this.getFragment();var q=m.any(this.handlers,function(s){if(s.route.test(r)){s.callback(r);return true}});return q},saveLocation:function(q){q=(q||"").replace(l,"");if(this.fragment==q){return}window.location.hash=this.fragment=q;if(this.iframe&&(q!=this.getFragment(this.iframe.location))){this.iframe.document.open().close();this.iframe.location.hash=q}}});k.View=function(q){this._configure(q||{});this._ensureElement();this.delegateEvents();this.initialize(q)};var a=function(q){return e(q,this.el)};var n=/^(\w+)\s*(.*)$/;m.extend(k.View.prototype,k.Events,{tagName:"div",$:a,initialize:function(){},render:function(){return this},remove:function(){e(this.el).remove();return this},make:function(r,q,t){var s=document.createElement(r);if(q){e(s).attr(q)}if(t){e(s).html(t)}return s},delegateEvents:function(v){if(!(v||(v=this.events))){return}e(this.el).unbind();for(var u in v){var s=v[u];var t=u.match(n);var r=t[1],q=t[2];var w=m.bind(this[s],this);if(q===""){e(this.el).bind(r,w)}else{e(this.el).delegate(q,r,w)}}},_configure:function(q){if(this.options){q=m.extend({},this.options,q)}if(q.model){this.model=q.model}if(q.collection){this.collection=q.collection}if(q.el){this.el=q.el}if(q.id){this.id=q.id}if(q.className){this.className=q.className}if(q.tagName){this.tagName=q.tagName}this.options=q},_ensureElement:function(){if(this.el){return}var q={};if(this.id){q.id=this.id}if(this.className){q["class"]=this.className}this.el=this.make(this.tagName,q)}});var g=function(q,r){var s=i(this,q,r);s.extend=g;return s};k.Model.extend=k.Collection.extend=k.Controller.extend=k.View.extend=g;var b={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};k.sync=function(w,r,u,q){console.log("sync",w+":"+r+":"+u+":"+q);var s=b[w];var v=(w==="create"||w==="update")?JSON.stringify(r.toJSON()):null;var t={url:h(r),type:s,contentType:"application/json",data:v,dataType:"json",processData:false,success:u,error:q};if(k.emulateJSON){t.contentType="application/x-www-form-urlencoded";t.processData=true;t.data=v?{model:v}:{}}if(k.emulateHTTP){if(s==="PUT"||s==="DELETE"){if(k.emulateJSON){t.data._method=s}t.type="POST";t.beforeSend=function(x){x.setRequestHeader("X-HTTP-Method-Override",s)}}}e.ajax(t)};var j=function(){};var i=function(r,q,s){var t;if(q&&q.hasOwnProperty("constructor")){t=q.constructor}else{t=function(){return r.apply(this,arguments)}}j.prototype=r.prototype;t.prototype=new j();if(q){m.extend(t.prototype,q)}if(s){m.extend(t,s)}t.prototype.constructor=t;t.__super__=r.prototype;return t};var h=function(q){if(!(q&&q.url)){throw new Error("A 'url' property or function must be specified")}return m.isFunction(q.url)?q.url():q.url};var d=function(s,r,q){return function(t){if(s){s(r,t)}else{r.trigger("error",r,t,q)}}};var o=function(q){return q.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}})();function S4(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}function guid(){return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4())}window.Store=function(b){this.name=b;var a=localStorage.getItem(this.name);this.records=(a&&a.split(","))||[];$(window).bind("online",this.sendPending);var c=localStorage.getItem(this.name+"-pending");this.pending=(c&&c.split(","))||[]};$.ajaxSetup({cache:false});_.extend(Store.prototype,{save:function(){console.log("Store:save");localStorage.setItem(this.name,this.records.join(","));localStorage.setItem(this.name+"-pending",this.pending.join(","))},create:function(a){if(!a.id){a.set({id:guid()},{silent:false})}a.set({pending:true});console.log("Store:create",a.id);localStorage.setItem(this.name+"-"+a.id,JSON.stringify(a));this.records.push(a.id.toString());this.pending.push(a.id.toString());this.save();this.sendPending();return a},update:function(a){console.log("Store:update",a.id);localStorage.setItem(this.name+"-"+a.id,JSON.stringify(a));if(!_.include(this.records,a.id.toString())){this.records.push(a.id.toString())}if(!_.include(this.pending,a.id.toString())){this.pending.push(a.id.toString())}this.save();return a},find:function(a){return JSON.parse(localStorage.getItem(this.name+"-"+a.id))},findAll:function(){return _.map(this.records,function(a){return JSON.parse(localStorage.getItem(this.name+"-"+a))},this)},destroy:function(a){console.log("Store:destroy",a.id);localStorage.removeItem(this.name+"-"+a.id);this.records=_.reject(this.records,function(b){return b==a.id.toString()});this.save();return a},clear:function(){localStorage.removeItem(this.name);_.each(this.records,$.proxy(function(a){localStorage.removeItem(this.name+"-"+a.id)},this));this.records=[]},sendPending:function(){if(window.navigator.onLine){console.log("send pending")}},fetch:function(a){},exists:function(){alert(localStorage.getItem(this.name))},loadFromDB:function(c,f,b){Backbone.sync=Backbone.syncLocal;var a=$.proxy(function(i,j,h){this.clear();var g=_.pluck(i,"id").join(",");localStorage.setItem(this.name,g);$(i).each($.proxy(function(k,l){localStorage.setItem(this.name+"-"+l.id,JSON.stringify(l))},this));this.records=(g&&g.split(","))||[];f&&f(i,j,h)},this);var d=$.proxy(function(g,h,i){h&&h(g,h,i)},this);var e={url:c,type:"GET",contentType:"application/json",dataType:"json",processData:false,success:a,error:d};$.ajax(e)},saveToDB:function(d,h,c){var a=this.findAll();var f=JSON.stringify(a);var b=$.proxy(function(j,k,i){this.clear();$(j).each($.proxy(function(m,n){var l=Todos.get(n.from_id);l.set({id:n.id});this.update(l)},this))},this);var e=$.proxy(function(i,j,k){j&&j(i,j,k)},this);var g={url:d,type:"PUT",contentType:"application/json",data:f,dataType:"json",processData:false,success:b,error:e};$.ajax(g)}});Backbone.syncLocal=function(f,c,e,b){console.log("SYNC",f);var d;var a=c.localStorage||c.collection.localStorage;switch(f){case"read":d=c.id?a.find(c):a.findAll();break;case"create":d=a.create(c);break;case"update":d=a.update(c);break;case"delete":d=a.destroy(c);break}if(d){e(d)}else{b("Record not found")}};Backbone.origSync=Backbone.sync;